<!DOCTYPE html>
<html lang="en">

<head>
    <!-- BUG: Load in ARC and it thinks this is not English!  (First word Spem??) -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Spem Player</title>
    <link rel="icon" href="https://fav.farm/ðŸ”¥">
    <link rel="stylesheet" href="./index.css">
    <!-- TODO: include main.js as separate file.  But needs to be easy to install on sv.co.uk -->

</head>

<body>

    <style>



    </style>

    <div class="wrapper">
        <!-- TODO: Needs version - ideally auto-increasing somehow -->
        <header>Spem Player
        </header>
        <div id="spemFrame">
            <canvas id="spemCanvas" autofocus>
                Your browser does not support the HTML canvas element.
            </canvas>
        </div>
        <!-- TODO: use id= for controls, playpause and controlsection -->
        <div class="controls">
            <div class="playpause" tabindex="0">
                <span id="playpausebutton" class="button paused control"></span>
            </div>
            <!-- TODO: Can we populate choir, part and bar from parameters in the URL? -->
            <div class="controlsection choircontrol">
                <label for="choir">Choir</label>
                <select name="choir" id="choir-select" class="control">
                    <option value="0">All</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                </select>
            </div>
            <div class="controlsection partcontrol">
                <label for="part">Part</label>
                <select name="part" id="part-select" disabled="" class="control">
                    <option value="0">All</option>
                    <option value="1">Soprano</option>
                    <option value="2">Alto</option>
                    <option value="3">Tenor</option>
                    <option value="4">Baritone</option>
                    <option value="5">Bass</option>
                </select>
            </div>
            <!-- BUG: on mobile, bar input field is bigger than select fields -->
            <div class="controlsection barcontrol">
                <label for="bar">Bar</label>
                <input type="number" name="bar" id="bar-field" value="0" min="0" max="138" class="control" />
            </div>

            <div class="statusspacer"></div>

            <!-- BUG: do we really need class=status?  there's nothing else in statusarea. -->
            <div class="statusarea">
                <span id="choir-output" class="status">All</span>
                <span id="part-output" class="status">All</span>
                <span id="bar-output" class="status">0</span>
            </div>

        </div>
    </div>
    <div id="blurb">
        <p><em>Spem in alium</em> - Thomas Tallis (1505 - 1585). Recordings by <a
                href="https://www.choirsoftheearth.com">Choir of the Earth</a>.</p>
        <p id="copyright">Â© 2024, Mark Wainwright</p>
    </div>

    <script>

        // TODO: Perhaps locations = { json: <String>, defaultaudio: <String>, audio: <String>[8][5] }?
        let defaultaudiofile = '../audio/spem.mp3';
        let jsonFilename = './spem.json';

        // HACK: different filenames when on southernvoices.co.uk
        // I can't control the filenames when installed on southernvoices.co.uk
        // so they are hardcoded here.  Ugh.  Sorry.
        const sv = window.location.hostname.includes('southernvoices');
        let svfiles = [];
        if (sv) {
            jsonFilename = '/db_uploads/Spem_in_alium-spem-2.json_17083537375324.json';
            defaultaudiofile = '/db_uploads/Spem_in_alium-Whole_choir_17079473660428.mp3';
            svfiles = [
                [
                    '/db_uploads/Spem_in_alium-Choir_1_-_Soprano_17079379676027.mp3',
                    '/db_uploads/Spem_in_alium-Choir_1_-_Alto_17079463591475.mp3',
                    '/db_uploads/Spem_in_alium-Choir_1_-_Tenor_17079464291625.mp3',
                    '/db_uploads/Spem_in_alium-Choir_1_-_Baritone_17079464558424.mp3',
                    '/db_uploads/Spem_in_alium-Choir_1_-_Bass_17079464967852.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_2_-_Soprano_17079465329272.mp3',
                    '/db_uploads/Spem_in_alium-Choir_2_-_Alto_1707946557566.mp3',
                    '/db_uploads/Spem_in_alium-Choir_2_-_Tenor_17079465811394.mp3',
                    '/db_uploads/Spem_in_alium-Choir_2_-_Baritone_17079466024846.mp3',
                    '/db_uploads/Spem_in_alium-Choir_2_-_Bass_17079466248904.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_3_-_Soprano_17079467897051.mp3',
                    '/db_uploads/Spem_in_alium-Choir_3_-_Alto_17079468079962.mp3',
                    '/db_uploads/Spem_in_alium-Choir_3_-_Tenor_17079468289072.mp3',
                    '/db_uploads/Spem_in_alium-Choir_3_-_Baritone_17079468478816.mp3',
                    '/db_uploads/Spem_in_alium-Choir_3_-_Bass_17079468681164.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_4_-_Soprano_17079468930359.mp3',
                    '/db_uploads/Spem_in_alium-Choir_4_-_Alto_17079469103372.mp3',
                    '/db_uploads/Spem_in_alium-Choir_4_-_Tenor_17079469295052.mp3',
                    '/db_uploads/Spem_in_alium-Choir_4_-_Baritone_17079492066201.mp3',
                    '/db_uploads/Spem_in_alium-Choir_4_-_Bass_17079469457173.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_5_-_Soprano_17079469713956.mp3',
                    '/db_uploads/Spem_in_alium-Choir_5_-_Alto_17079469890646.mp3',
                    '/db_uploads/Spem_in_alium-Choir_5_-_Tenor_17079470084183.mp3',
                    '/db_uploads/Spem_in_alium-Choir_5_-_Baritone_17079470332751.mp3',
                    '/db_uploads/Spem_in_alium-Choir_5_-_Bass_17079470531725.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_6_-_Soprano_17079470789921.mp3',
                    '/db_uploads/Spem_in_alium-Choir_6_-_Alto_17079471031399.mp3',
                    '/db_uploads/Spem_in_alium-Choir_6_-_Tenor_1707947123417.mp3',
                    '/db_uploads/Spem_in_alium-Choir_6_-_Baritone_17079471420792.mp3',
                    '/db_uploads/Spem_in_alium-Choir_6_-_Bass_17079492502735.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_7_-_Soprano_17079471702897.mp3',
                    '/db_uploads/Spem_in_alium-Choir_7_-_Alto_17079471917271.mp3',
                    '/db_uploads/Spem_in_alium-Choir_7_-_Tenor_17079472111989.mp3',
                    '/db_uploads/Spem_in_alium-Choir_7_-_Baritone_17079472290499.mp3',
                    '/db_uploads/Spem_in_alium-Choir_7_-_Bass_17079472450269.mp3'
                ],
                [
                    '/db_uploads/Spem_in_alium-Choir_8_-_Soprano_17079472689341.mp3',
                    '/db_uploads/Spem_in_alium-Choir_8_-_Alto_1707947288511.mp3',
                    '/db_uploads/Spem_in_alium-Choir_8_-_Tenor_17079473070395.mp3',
                    '/db_uploads/Spem_in_alium-Choir_8_-_Baritone_17079473259201.mp3',
                    '/db_uploads/Spem_in_alium-Choir_8_-_Bass_17079473467767.mp3'
                ]
            ]
        }

        // TODO: Wait for loading? Or disabled play till loaded?
        var spemaudio = new Audio(defaultaudiofile);

        // const beattime = 0.97; // seconds per beat
        const beattime = 0.967;

        let timerId = 0;

        const container = document.getElementById("spemFrame");
        const canvas = document.getElementById("spemCanvas");
        const playpausebutton = document.getElementById('playpausebutton');
        const choirselect = document.getElementById('choir-select');
        const partselect = document.getElementById('part-select');
        const barinput = document.getElementById('bar-field');
        const choiroutput = document.getElementById('choir-output');
        const partoutput = document.getElementById('part-output');
        const baroutput = document.getElementById('bar-output');

        const allparts = ['soprano', 'alto', 'tenor', 'baritone', 'bass'];

        let barWidth = 0;
        let choirHeight = 0;
        let partHeight = 0;

        // https://github.com/PimpTrizkit/PJs/wiki/12.-Shade,-Blend-and-Convert-a-Web-Color-(pSBC.js)#stackoverflow-archive-begin
        // Version 4.0
        const pSBC = (p, c0, c1, l) => {
            let r, g, b, P, f, t, h, i = parseInt, m = Math.round, a = typeof (c1) == "string";
            if (typeof (p) != "number" || p < -1 || p > 1 || typeof (c0) != "string" || (c0[0] != 'r' && c0[0] != '#') || (c1 && !a)) return null;
            if (!this.pSBCr) this.pSBCr = (d) => {
                let n = d.length, x = {};
                if (n > 9) {
                    [r, g, b, a] = d = d.split(","), n = d.length;
                    if (n < 3 || n > 4) return null;
                    x.r = i(r[3] == "a" ? r.slice(5) : r.slice(4)), x.g = i(g), x.b = i(b), x.a = a ? parseFloat(a) : -1
                } else {
                    if (n == 8 || n == 6 || n < 4) return null;
                    if (n < 6) d = "#" + d[1] + d[1] + d[2] + d[2] + d[3] + d[3] + (n > 4 ? d[4] + d[4] : "");
                    d = i(d.slice(1), 16);
                    if (n == 9 || n == 5) x.r = d >> 24 & 255, x.g = d >> 16 & 255, x.b = d >> 8 & 255, x.a = m((d & 255) / 0.255) / 1000;
                    else x.r = d >> 16, x.g = d >> 8 & 255, x.b = d & 255, x.a = -1
                } return x
            };
            h = c0.length > 9, h = a ? c1.length > 9 ? true : c1 == "c" ? !h : false : h, f = this.pSBCr(c0), P = p < 0, t = c1 && c1 != "c" ? this.pSBCr(c1) : P ? { r: 0, g: 0, b: 0, a: -1 } : { r: 255, g: 255, b: 255, a: -1 }, p = P ? p * -1 : p, P = 1 - p;
            if (!f || !t) return null;
            if (l) r = m(P * f.r + p * t.r), g = m(P * f.g + p * t.g), b = m(P * f.b + p * t.b);
            else r = m((P * f.r ** 2 + p * t.r ** 2) ** 0.5), g = m((P * f.g ** 2 + p * t.g ** 2) ** 0.5), b = m((P * f.b ** 2 + p * t.b ** 2) ** 0.5);
            a = f.a, t = t.a, f = a >= 0 || t >= 0, a = f ? a < 0 ? t : t < 0 ? a : a * P + t * p : 0;
            if (h) return "rgb" + (f ? "a(" : "(") + r + "," + g + "," + b + (f ? "," + m(a * 1000) / 1000 : "") + ")";
            else return "#" + (4294967296 + r * 16777216 + g * 65536 + b * 256 + (f ? m(a * 255) : 0)).toString(16).slice(1, f ? undefined : -2)
        }

        // TODO: put these colours in a config object? or as
        // SASS variables?
        const backgroundColor = "#123456";
        const lineColor = "#FFFFFF"
        // BUG: Choir 8 blue is too dark for the background
        const choirColors = [
            "#c1121f",
            "#ce6d8b",
            "#FF8531",
            "#FFA600",
            "#72B043",
            "#2B7654",
            "#13788D",
            "#003f88"
        ];

        // Parse "21.75-25.5" into two floats
        function getRange(s) {
            if (!s) return [999, 999];
            return s.split("-").map(numStr => parseFloat(numStr));
        }

        let choirs = undefined;

        // TODO: use async await to make more readable?
        function paintJsonToCanvas(filename) {
            fetch(filename)
                .then(response => response.json())
                .then(music => {
                    choirs = music.choirs;
                    paintCanvas(music.choirs);
                });
        }

        // use changed to know whether we need to redraw or not
        var changed = true;

        // TODO: Check if choir has changed (like for bar below)
        function setChoir(c) {
            choirselect.value = c;
            changed = true;
        }

        // TODO: Check if part has changed (like for bar below)
        function setPart(p) {
            partselect.value = p;
            changed = true;
        }

        function setBar(b) {
            const oldBar = barinput.value;
            if (b != oldBar) {
                barinput.value = b;
                changed = true;
            }
        }

        // TODO: Should canvas have a 'padding' so that highlight on choir/part = 1/1 and 8/5 doesn't
        // look cut off?  And so that you don't have square line ends for the last bar?
        // And how many bars are there exactly? 138, 139, 140?
        function paintCanvas() {

            if (!changed) {
                return;
            }
            changed = false;

            const ctx = canvas.getContext("2d");
            ctx.fillStyle = backgroundColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw background line if this is the selected choir/part
            if (choirselect.value != 0 && partselect.value != 0) {
                const c = Number(choirselect.value) - 1;
                const p = Number(partselect.value) - 1;
                const startY = c * choirHeight + p * partHeight;
                ctx.beginPath();
                ctx.moveTo(10, startY + (partHeight / 2));
                ctx.lineTo(138 * barWidth - 10, startY + (partHeight / 2));
                ctx.lineWidth = partHeight * 1.3;
                ctx.strokeStyle = '#f6f3a8';
                ctx.lineCap = "round";
                ctx.stroke();
            }

            for (let c = 0; c < 8; c++) {
                const parts = choirs[c].parts;
                for (let p = 0; p < 5; p++) {
                    const startY = c * choirHeight + p * partHeight;

                    // BUG: right hand side of line at bar 138 is not round but square
                    const ranges = parts[p].ranges;
                    ranges.forEach(r => {
                        const [from, to] = getRange(r);
                        ctx.beginPath();
                        ctx.moveTo((from + 0.4) * barWidth, startY + (partHeight / 2));
                        ctx.lineTo((to - 0.6) * barWidth, startY + (partHeight / 2));
                        ctx.lineWidth = 0.9 * partHeight;
                        ctx.strokeStyle = pSBC(0.24 - (0.08 * p), choirColors[c]);
                        ctx.lineCap = "round";
                        ctx.stroke();
                        // ctx.fillStyle = pSBC(0.24 - (0.08 * p), choirColors[c]);
                        // ctx.fillRect((from - 1) * barWidth, startY, (to - from + 1) * barWidth, partHeight);
                    });
                }
            }

            // BUG: when bar === 0, line is only half drawn
            // BUG: line should be thicker on mobile
            ctx.save();
            let b = barinput.value;
            ctx.beginPath();
            ctx.moveTo(b * barWidth, 0);
            ctx.lineTo(b * barWidth, canvas.height);
            ctx.setLineDash([partHeight / 2, partHeight / 2]);
            ctx.lineWidth = barWidth / 2;
            ctx.strokeStyle = lineColor;
            ctx.stroke();
            ctx.restore();
        }

        function getMousePos(canv, evt) {
            const rect = canv.getBoundingClientRect();
            const y = (evt.offsetY * 8) / rect.height;
            return [
                Math.floor(y + 1),
                Math.floor(((y % 1) * 5) + 1),
                Math.floor(((evt.offsetX * 138) / rect.width) + 1),
            ];
        }

        // TODO: define all filenames up above, so there's no need
        // for the yucky sv variable here.  SHould just be
        //  file = location.audio[c-1][p-1];
        function loadAudio(c, p, b) {
            let file = defaultaudiofile;
            if (c != '0' && p != '0') {
                file = sv ? svfiles[c - 1][p - 1]
                    : `../audio/spem-${c}-${getPartName(p)}.mp3`;
            }

            spemaudio.src = file;
            // TODO: Wait for loading? Or disabled play till loaded?

            spemaudio.currentTime = b * 4 * beattime;
        }

        // TODO: Are you sure spemaudio is loaded?
        function playSpem() {
            if (spemaudio.paused) {
                spemaudio.play();
                playpausebutton.classList.remove("paused");
                clearInterval(timerId);
                // BUG: at the end of the piece, the bar number climbs to 141 and the playpause 
                // button never reverts to play. Does the timer ever stop??
                timerId = setInterval(() => {
                    setBar(Math.floor(spemaudio.currentTime / (beattime * 4)));
                    paintCanvas();
                }, beattime * 100);
            }
        }

        function pauseSpem() {
            if (!spemaudio.paused) {
                spemaudio.pause();
                playpausebutton.classList.add("paused");
                clearInterval(timerId);
            }
        }

        function playpause() {
            if (spemaudio.paused) {
                playSpem();
            }
            else {
                pauseSpem();
            }
        }

        // BUG: never used
        function getPartNumber(s) {
            return allparts.indexOf(s) + 1;
        }

        function getPartName(n) {
            return allparts[n - 1];
        }

        // TODO:  Move functions to the right places
        paintJsonToCanvas(jsonFilename);

        // TODO: put all event listeners in a single block on page load?  Or json load?  or something?

        playpausebutton.addEventListener('click', playpause);

        canvas.addEventListener('click', function (evt) {
            const [c, p, b] = getMousePos(canvas, evt);

            setChoir(c);
            setPart(p);
            setBar(b);

            userInputChanged();
            playSpem();
        });

        // BUG: Should not display this area when mouse not possible
        // e.g. for mobile devices
        // TODO: Make the status section invisible except for the second or so
        // when they have just moved the mouse. It's really just there to help people know 
        // where they are about to click.
        canvas.addEventListener('mousemove', function (e) {
            const [c, p, b] = getMousePos(canvas, e);

            choiroutput.innerHTML = "Choir " + c;
            partoutput.innerHTML = getPartName(p);
            baroutput.innerHTML = "Bar " + b;

        }, false);

        // Change the MP3 file if they change the choir, part or bar
        [choirselect,
            partselect,
            barinput].forEach(el => el.addEventListener('change', userInputChanged));

        function userInputChanged() {
            changed = true;
            pauseSpem();
            // If Choir or Part is All, then set the other to All
            if (choirselect.value === '0') {
                setPart(0);
                partselect.disabled = true;
            }
            else {
                if (partselect.value === '0') {
                    setPart(1);
                }
                partselect.disabled = false;
            }
            paintCanvas();

            loadAudio(choirselect.value, partselect.value, barinput.value);
        }

        // TODO: Need to tell user the keyboard controls somewhere
        // TODO: Use x to clear choir/part?
        document.addEventListener("keydown", (event) => {
            // don't handle keyboard events on the four control widgets
            // cos it messes with the UI interaction
            const classes = [...event.target.classList];
            if (classes.includes('control')) {
                return;
            }
            if (event.isComposing || event.keyCode === 229) {
                return;
            }
            if (event.code == 'Enter') {
                playpause();
                return;
            }
            if (event.code === 'KeyD') {
                setBar(Number(barinput.value) + 1);
            }
            else if (event.code === 'KeyA') {
                setBar(Number(barinput.value) - 1);
            }
            // TODO: Clumsy code.  Use mod arithmetic maybe?
            else if (event.code === 'KeyS') {
                let c = Number(choirselect.value);
                let p = Number(partselect.value);
                if (c === 8 && p === 5) {
                    c = 0;
                    p = 0;
                }
                else if (c === 0 && p === 0) {
                    c = 1;
                    p = 1;
                }
                else {
                    p++;
                    if (p > 5) {
                        p = 1;
                        c++;
                    }
                }
                setChoir(c);
                setPart(p);
            }
            else if (event.code === 'KeyW') {
                let c = Number(choirselect.value);
                let p = Number(partselect.value);
                if (c === 1 && p === 1) {
                    c = 0;
                    p = 0;
                }
                else if (c === 0 && p === 0) {
                    c = 8;
                    p = 5;
                }
                else {
                    p--;
                    if (p < 1) {
                        p = 5;
                        c--;
                    }
                }
                setChoir(c);
                setPart(p);
            }

            userInputChanged();
        });

        // TODO: convert to addEventListener for consistency
        window.onload = window.onresize = calculateCanvasSize;

        function calculateCanvasSize() {
            canvas.width = container.clientWidth * 4;
            canvas.height = 300 * 4;

            barWidth = canvas.width / 138;
            choirHeight = canvas.height / 8;
            partHeight = choirHeight / 5;

            // console.log(`calculateCanvasSize(): barWidth=${barWidth}, choirHeight=${choirHeight}, partHeight=${partHeight}`)

            changed = true;
            paintCanvas();
        }

        // TODO: Not convinced the Maths for getTouchPos() is right...
        function getTouchPos(evt) {
            // TOSO: rect not used!
            const rect = canvas.getBoundingClientRect();
            // BUG: 139?? 138? 140? 138 bars of music plus a bar at the start and at the end?  And padding?
            return (evt.targetTouches[0].pageX * 139 / canvas.clientWidth);
        }

        // BUG: on mobile, touch to move bar to half-way and play
        // and it starts from bar 0.
        let touchBar = -1;
        canvas.addEventListener("touchstart", (evt) => {
            touchBar = getTouchPos(evt);
            setBar(Number(touchBar));
            userInputChanged();

            // BUG: [Violation] Added non-passive event listener to a scroll-blocking <some> event.
            // Can we use no bubble thing instead of preventDefault()?  Don't want gestures on canvas
            // to move the screen around when on mobile.
            evt.preventDefault();

            canvas.addEventListener("touchmove", (evt) => {
                pauseSpem();
                touchBar = getTouchPos(evt);
                setBar(Number(touchBar));
                userInputChanged();
                evt.preventDefault();
            });
            canvas.addEventListener("touchend", (evt) => {
                playSpem();
            });
        });


    </script>

</body>

</html>